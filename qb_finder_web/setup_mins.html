<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Minimals</title>

    <link rel="icon" href="https://monkieeboi.github.io/pc/favicon.ico" />
    <link rel="stylesheet" href="style.css" />
    <style type="text/css">
    </style>
  </head>

  <body>
    <header id="header">
      <h1>Minimals</h1>
      <div class="loading"></div>
    </header>

    <section>
      <h2>Common</h2>
      <div id="common">
        <div class="loading"></div>
        <div class="loading"></div>
        <div class="loading"></div>
      </div>
    </section>

    <section id="unique"></section>

    <script src="mino-board.js"></script>
    <script src="pkg/qb_finder_web.js"></script>
    <script type="module">
      const { encoder, Field } = await import("https://cdn.jsdelivr.net/npm/tetris-fumen/+esm");
      let worker = new Worker("worker.js");
      let header = document.getElementById("header");
      let common = document.getElementById("common");
      let unique = document.getElementById("unique");
      const params = new URLSearchParams(window.location.search);

      worker.onmessage = message => {
        if (message.data.kind == "ready") {
          worker.postMessage({
            setup: params.get("setup"),
            build_queue: params.get("build_queue"),
            solve_queue: params.get("solve_queue"),
            save: params.get("save")
          });
          return;
        }
        let [board, commons, ...uniques] = message.data.res.split("|");

        document.querySelectorAll(".loading").forEach((el) => el.remove());

        header.appendChild(new MinoBoard(board));

        for (const solve of commons.split(",")) {
          const mino_board = new MinoBoard(solve);
          mino_board.addEventListener("click", (e) => {
              navigator.clipboard.writeText(encoder.encode([{field:Field.create(solve.replaceAll("G","X")),flags:{lock:false}}]));
          });
          common.appendChild(mino_board);
        }

        for (const [i, solves] of uniques.entries()) {
          if (solves == "") {
            continue;
          }
          let container = document.createElement("div");
          let label = document.createElement("h2");
          label.textContent = `Set ${i + 1}`;
          unique.appendChild(label);
          for (const solve of solves.split(",")) {
            const mino_board = new MinoBoard(solve);
            mino_board.addEventListener("click", (e) => {
                navigator.clipboard.writeText(encoder.encode([{field:Field.create(solve.replaceAll("G","X")),flags:{lock:false}}]));
            });
            container.appendChild(mino_board);
          }
          unique.appendChild(container);
        }
      }
    </script>
  </body>
</html>
