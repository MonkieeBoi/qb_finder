<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <title>QB Finder</title>

    <link rel="icon" href="https://monkieeboi.github.io/pc/favicon.ico" />
    <link rel="stylesheet" href="style.css" />
    <script src="mino-board.js"></script>
</head>

<body>

 <div id="query">

        <h1>QB Finder</h1>

        <div>
            <div class="label">Queues</div>
        </div>
        <div style="display: grid; gap: 5px;">
            <input type="text" id="build_queue" placeholder="T,TSZ">
            <input type="text" id="solve_queue" placeholder="T,LJ,I,OSZ">
            <input type="text" id="save" maxlength="1" value="T">
            <label><input id="skip_4p" type="checkbox"> Skip 4p</label>
        </div>

    </div>

    <div id="loading">Loading finder...</div>

    <div id="solutions">
        <div class="loading" hidden></div>
        <div class="loading" hidden></div>
        <div class="loading" hidden></div>
    </div>

    <script src="pkg/qb_finder_web.js"></script>

    <script type="module">
        let worker = new Worker("worker.js");
        let work = null;

        let build_queue = document.getElementById("build_queue");
        let solve_queue = document.getElementById("solve_queue");
        let solutions = document.getElementById("solutions");
        let skip_4p = document.getElementById("skip_4p");
        let save = document.getElementById("save");

        worker.onmessage = message => {
            if (message.data.kind == "ready") {
                document.getElementById("loading").remove();

                if (work != null) {
                    worker.postMessage(work);
                    document.querySelectorAll(".loading").forEach((el) => el.hidden = false);
                }
                return;
            }

            if (message.data.query.build_queue != work.build_queue
                || message.data.query.solve_queue != work.solve_queue) {
                worker.postMessage(work);
                return;
            }

            document.querySelectorAll(".loading").forEach((el) => el.hidden = true);
            let count = message.data.setups.length;
            showSetups(message.data.setups, count);

            work = null;

        }

        function showSetups(setups, count) {
            if (setups.length == 0) {
                solutions.append("no setups");
            }

            for (const setup of setups) {
                if (count == 0) { break; }
                count--;
                const [board, min_count, encoded] = setup.split(",")
                const params = new URLSearchParams();
                params.set('setup', encoded);
                params.set('build_queue', work.build_queue);
                params.set('solve_queue', work.solve_queue);
                params.set('save', work.save);
                let link = document.createElement("a");
                link.appendChild(new MinoBoard(board));
                if (min_count > 0) {
                    link.title = `Min Count: ${min_count}`;
                    link.href = `./setup_mins.html?${params.toString()}`;
                    link.target = "_blank";
                }

                solutions.appendChild(link);
            }
        }

        function doSolve() {
            work = {
                build_queue: build_queue.value,
                solve_queue: solve_queue.value,
                save: save.value,
                skip_4p: skip_4p.checked
            };
            if (!document.getElementById('loading')) {
                solutions.querySelectorAll(':nth-child(n+4)').forEach(el => el.remove());
                document.querySelectorAll(".loading").forEach((el) => el.hidden = false);
                worker.postMessage(work);
            }
        }

        [build_queue, solve_queue, save].forEach(input => {
            input.addEventListener("beforeinput", function (event) {
                if (event.data && !/[toiljsz,]/ig.test(event.data)) {
                    event.preventDefault();
                }
            });
        })

        window.addEventListener("keydown", (ev) => {
            if (ev.key == "Enter" || ev.keyCode == 13 || ev.which == 13) {
                doSolve();
            }
        });

        solve_queue.addEventListener("keydown", (ev) => {
            if (ev.key == " " || ev.code == "Space" || ev.keyCode == 32) {
                const pieces = new Set("TIJLOSZ");
                const sset = new Set(solve_queue.value);

                const remaining = pieces.difference(sset);

                if (remaining.size > 0) {
                    solve_queue.value += "," + [...remaining].join('');
                }

                ev.preventDefault();
            }
        });
    </script>

</body>

</html>
